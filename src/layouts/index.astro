---
import "./styles/global.css"
import { pwaInfo } from "virtual:pwa-info"

interface Props {
	meta: {
		description: string
		ogImage?: string
		ogType?: string
		preloadHero?: boolean
		robots?: string[]
		title: string
	}
	schema?: Record<string, unknown>
}

const { meta, schema } = Astro.props

const { pathname } = Astro.url

const isHome = pathname.length < 2

const {
	description,
	ogImage = "/og-image.png",
	ogType = "website",
	preloadHero = true,
	robots = ["index", "follow"],
	title,
} = meta

const siteOrigin = Astro.site?.origin ?? "https://cyberfern.com"
const ogUrl = `${siteOrigin}${Astro.url.pathname}`
const ogImageAbsolute = `${siteOrigin}${ogImage}`

const breadcrumbSchema = isHome
	? null
	: {
			"@context": "https://schema.org",
			"@type": "BreadcrumbList",
			"itemListElement": [
				{
					"@type": "ListItem",
					"position": 1,
					"name": "Home",
					"item": `${siteOrigin}/`,
				},
				{
					"@type": "ListItem",
					"position": 2,
					"name": title.split(" | ")[0],
				},
			],
		}

const organizationSchema = {
	"@context": "https://schema.org",
	"@type": "Organization",
	"name": "CyberFern",
	"url": siteOrigin,
	"logo": `${siteOrigin}/favicon.svg`,
	"description": "Cybersecurity made practical, proportionate, and human.",
	"founder": {
		"@type": "Person",
		"name": "Anna Lezhikova",
	},
	"address": {
		"@type": "PostalAddress",
		"addressLocality": "Wellington",
		"addressCountry": "NZ",
	},
	"contactPoint": {
		"@type": "ContactPoint",
		"email": "info@cyberfern.com",
		"contactType": "customer service",
	},
	"sameAs": ["https://www.linkedin.com/in/annalezhikova/"],
}

const navItems = [
	{
		label: "Startups",
		href: "/startups/",
		title: "Cybersecurity for startups.",
	},
	{
		label: "Small\u00A0Businesses",
		href: "/small-businesses/",
		title: "Cybersecurity for small businesses.",
	},
	{
		label: "Workshops",
		href: "/workshops/",
		title: "Cybersecurity training workshops.",
	},
	{
		label: "Champions",
		href: "/champions/",
		title: "Security Champions programme.",
	},
	{ label: "About", href: "/about/", title: "About CyberFern." },
	{ label: "Contact", href: "/contact/", title: "Contact CyberFern." },
]

function isActive(href: string): boolean {
	const normPath = pathname.replace(/\/+$/, "") || "/"
	const normHref = href.replace(/\/+$/, "") || "/"
	return normPath === normHref
}
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="description"
			content={description}
		/>
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1"
		/>
		<meta
			name="theme-color"
			content="#134e31"
		/>
		<meta
			name="apple-mobile-web-app-capable"
			content="yes"
		/>
		<link
			href={Astro.url}
			rel="canonical"
		/>
		<meta
			name="robots"
			content={robots.join(", ")}
		/>
		<meta
			name="author"
			content="Anna Lezhikova"
		/>
		<meta
			name="publisher"
			content="Anna Lezhikova"
		/>
		<link
			rel="icon"
			type="image/svg+xml"
			href="/favicon.svg"
		/>
		<link
			rel="icon"
			type="image/x-icon"
			href="/favicon.ico"
			sizes="32x32"
		/>
		<link
			rel="apple-touch-icon"
			href="/apple-touch-icon.png"
		/>
		{
			preloadHero && (
				<link
					rel="preload"
					as="image"
					type="image/avif"
					href="/images/hero.avif"
				/>
			)
		}
		<title>{title}</title>

		<script
			type="application/ld+json"
			set:html={JSON.stringify(organizationSchema)}
		/>
		{
			schema && (
				<script
					type="application/ld+json"
					set:html={JSON.stringify(schema)}
				/>
			)
		}
		{
			breadcrumbSchema && (
				<script
					type="application/ld+json"
					set:html={JSON.stringify(breadcrumbSchema)}
				/>
			)
		}

		<!-- Open Graph -->
		<meta
			property="og:title"
			content={title}
		/>
		<meta
			property="og:description"
			content={description}
		/>
		<meta
			property="og:image"
			content={ogImageAbsolute}
		/>
		<meta
			property="og:url"
			content={ogUrl}
		/>
		<meta
			property="og:type"
			content={ogType}
		/>
		<meta
			property="og:site_name"
			content="CyberFern"
		/>

		<!-- Twitter Card -->
		<meta
			name="twitter:card"
			content="summary_large_image"
		/>
		<meta
			name="twitter:title"
			content={title}
		/>
		<meta
			name="twitter:description"
			content={description}
		/>
		<meta
			name="twitter:image"
			content={ogImageAbsolute}
		/>

		{pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}
	</head>
	<body>
		<a
			class="skip-link"
			href="#main-content"
			>Skip to main content</a
		>
		<header>
			<div class="logo">
				<p>
					{
						isHome ? (
							"CyberFern"
						) : (
							<a
								href="/"
								title="To the home page."
							>
								CyberFern
							</a>
						)
					}
				</p>
			</div>
			<nav aria-label="Main navigation">
				<ul class="nav-list">
					{
						navItems.map((item) =>
							isActive(item.href) ? (
								<li>
									<span
										aria-current="page"
										class="this-page"
										title="This page."
									>
										{item.label}
									</span>
								</li>
							) : (
								<li>
									<a
										href={item.href}
										title={item.title}
									>
										{item.label}
									</a>
								</li>
							),
						)
					}
				</ul>
				<details class="nav-mobile">
					<summary aria-label="Open menu">Menu</summary>
					<ul>
						{
							navItems.map((item) =>
								isActive(item.href) ? (
									<li>
										<span
											aria-current="page"
											class="this-page"
											title="This page."
										>
											{item.label}
										</span>
									</li>
								) : (
									<li>
										<a
											href={item.href}
											title={item.title}
										>
											{item.label}
										</a>
									</li>
								),
							)
						}
					</ul>
				</details>
			</nav>
		</header>
		<script>
			document.addEventListener("click", (e) => {
				const menu = document.querySelector(".nav-mobile")
				if (menu?.open && !menu.contains(e.target as Node)) {
					menu.open = false
				}
			})
		</script>
		<slot />
		<footer>
			<h2 class="sr-only">Site footer</h2>
			<p class="footer-tagline">
				Cybersecurity made practical, proportionate, and human.
			</p>
			<nav
				aria-label="Footer navigation"
				class="footer-nav"
			>
				<ul>
					{
						navItems.map((item) => (
							<li>
								<a
									href={item.href}
									title={item.title}
								>
									{item.label}
								</a>
							</li>
						))
					}
				</ul>
			</nav>
			<nav
				aria-label="Legal"
				class="supplemental"
			>
				<ul>
					<li>
						{
							isActive("/privacy-policy/") ? (
								<span
									aria-current="page"
									class="this-page"
									title="This page."
								>
									Privacy
								</span>
							) : (
								<a
									href="/privacy-policy/"
									title="Our privacy policy"
								>
									Privacy
								</a>
							)
						}
					</li>
					<li>
						{
							isActive("/terms-of-use/") ? (
								<span
									aria-current="page"
									class="this-page"
									title="This page."
								>
									Terms
								</span>
							) : (
								<a
									href="/terms-of-use/"
									title="Our terms of use"
								>
									Terms
								</a>
							)
						}
					</li>
					<li>
						{
							isActive("/cookie-policy/") ? (
								<span
									aria-current="page"
									class="this-page"
									title="This page."
								>
									Cookies
								</span>
							) : (
								<a
									href="/cookie-policy/"
									title="Our cookie policy"
								>
									Cookies
								</a>
							)
						}
					</li>
				</ul>
			</nav>
			<section
				id="contact"
				class="contact-info"
			>
				<h3 class="sr-only">Contact info</h3>
				<a
					href="mailto:info@cyberfern.com"
					title="Email Anna"
					>info@cyberfern.com</a
				>
			</section>
		</footer>
		<script>
			import { registerSW } from "virtual:pwa-register"
			registerSW({ immediate: true })
		</script>
	</body>
</html>
